{% extends "base.html" %}

{% block title %}Backtest - AUTOBOT{% endblock %}

{% block header_title %}Backtest{% endblock %}

{% block content %}
<style>
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin: 20px;
    padding: 0;
}

.capital-chart-card {
    grid-column: 1 / -1;
    width: 100%;
    max-width: none;
}

.modules-card,
.metrics-card {
    grid-column: span 1;
    width: 100%;
    max-width: none;
}

@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .modules-card,
    .metrics-card {
        grid-column: 1;
    }
}

.card {
    background: rgba(0, 255, 157, 0.1);
    border: 1px solid #00ff9d;
    border-radius: 8px;
    padding: 20px;
    margin: 0;
    width: 100%;
    box-sizing: border-box;
    min-height: 200px;
}

.metrics-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-between;
    margin: 10px 0;
}

.metric-item {
    flex: 1;
    min-width: 150px;
    text-align: center;
    padding: 10px;
    background: rgba(0, 255, 157, 0.05);
    border-radius: 5px;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin: 20px;
    padding: 0;
}

.capital-chart-card {
    grid-column: 1 / -1;
    width: 100%;
    max-width: none;
}

.modules-card,
.metrics-card {
    grid-column: span 1;
    width: 100%;
    max-width: none;
}

@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .modules-card,
    .metrics-card {
        grid-column: 1;
    }
}

.card {
    background: rgba(0, 255, 157, 0.1);
    border: 1px solid #00ff9d;
    border-radius: 8px;
    padding: 20px;
    margin: 0;
    width: 100%;
    box-sizing: border-box;
    min-height: 200px;
}

.metrics-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-between;
    margin: 10px 0;
}

.metric-item {
    flex: 1;
    min-width: 150px;
    text-align: center;
    padding: 10px;
    background: rgba(0, 255, 157, 0.05);
    border-radius: 5px;
}
</style>

<div class="dashboard-grid">
    <!-- Automatic Backtest Status -->
    <div class="card">
        <div class="card-header">
            <h3 class="neon-text">Backtest Automatique</h3>
        </div>
        <div class="card-body">
            <div class="status-indicator">
                <span id="auto-status">Initialisation...</span>
            </div>
            
            <div class="metrics-row">
                <div class="metric-item">
                    <div class="metric-label">Rendement total</div>
                    <div class="metric-value neon-text" id="auto-total-return">0.00%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Rendement journalier</div>
                    <div class="metric-value neon-text" id="auto-daily-return">0.00%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Ratio de Sharpe</div>
                    <div class="metric-value neon-text" id="auto-sharpe">0.00</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Source de données</div>
                    <div class="metric-value neon-text" id="data-source">API Live</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label" id="last-update">Dernière mise à jour: --</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Évolution du Capital Fictif -->
    <div class="card capital-chart-card">
        <div class="card-header">
            <h3 class="neon-text">Évolution du Capital Fictif (500€ Initial)</h3>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="capitalChart" height="300"></canvas>
            </div>
            <div class="metrics-row" style="margin-top: 20px;">
                <div class="metric-item">
                    <div class="metric-label">Capital Actuel</div>
                    <div class="metric-value neon-text" id="current-capital">500.00€</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Variation</div>
                    <div class="metric-value" id="capital-change">0.00€</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Performance</div>
                    <div class="metric-value" id="capital-performance">0.00%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Module Activity Status -->
    <div class="card modules-card">
        <div class="card-header">
            <h3 class="neon-text">Activité des Modules</h3>
        </div>
        <div class="card-body">
            <div class="module-status">
                <div class="metric-item">
                    <div class="metric-label">Trading</div>
                    <div class="metric-value" id="trading-status">En attente...</div>
                    <div class="metric-value neon-text" id="trading-profit">0.00€</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">E-commerce</div>
                    <div class="metric-value" id="ecommerce-status">En attente...</div>
                    <div class="metric-value neon-text" id="ecommerce-profit">0.00€</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Arbitrage</div>
                    <div class="metric-value" id="arbitrage-status">En attente...</div>
                    <div class="metric-value neon-text" id="arbitrage-profit">0.00€</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Métriques Détaillées -->
    <div class="card metrics-card">
        <div class="card-header">
            <h3 class="neon-text">Métriques de Performance Détaillées</h3>
        </div>
        <div class="card-body">
            <div class="metrics-row">
                <div class="metric-item">
                    <div class="metric-label">Trades Total</div>
                    <div class="metric-value" id="total-trades">0</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Facteur de Profit</div>
                    <div class="metric-value" id="profit-factor">0.00</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Trade Moyen</div>
                    <div class="metric-value" id="avg-trade">0.00€</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Drawdown Max</div>
                    <div class="metric-value" id="max-drawdown">0.00%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Rendement Annualisé</div>
                    <div class="metric-value" id="annual-return">0.00%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let autoBacktestInterval;
let capitalChart;
let capitalData = [500]; // Start with initial 500€
let capitalLabels = ['Début'];

document.addEventListener('DOMContentLoaded', function() {
    console.log('Backtest page loaded');
    
    // Initialize capital chart
    initializeCapitalChart();
    
    // Initialize automatic backtest system
    startAutomaticBacktest();
});

function initializeCapitalChart() {
    const ctx = document.getElementById('capitalChart').getContext('2d');
    
    capitalChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: capitalLabels,
            datasets: [{
                label: 'Capital (€)',
                data: capitalData,
                borderColor: '#00ff9d',
                backgroundColor: 'rgba(0, 255, 157, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#ffffff'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                y: {
                    ticks: {
                        color: '#ffffff',
                        callback: function(value) {
                            return value + '€';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}

function updateCapitalChart(newCapital) {
    const now = new Date();
    const timeLabel = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');
    
    capitalData.push(newCapital);
    capitalLabels.push(timeLabel);
    
    // Keep only last 20 data points
    if (capitalData.length > 20) {
        capitalData.shift();
        capitalLabels.shift();
    }
    
    capitalChart.data.labels = capitalLabels;
    capitalChart.data.datasets[0].data = capitalData;
    capitalChart.update();
    
    // Update capital metrics
    const variation = newCapital - 500;
    const performance = ((newCapital - 500) / 500) * 100;
    
    document.getElementById('current-capital').textContent = newCapital.toFixed(2) + '€';
    document.getElementById('capital-change').textContent = (variation >= 0 ? '+' : '') + variation.toFixed(2) + '€';
    document.getElementById('capital-performance').textContent = (performance >= 0 ? '+' : '') + performance.toFixed(2) + '%';
    
    // Update color based on performance
    const changeElement = document.getElementById('capital-change');
    const performanceElement = document.getElementById('capital-performance');
    
    if (variation >= 0) {
        changeElement.style.color = '#00ff9d';
        performanceElement.style.color = '#00ff9d';
    } else {
        changeElement.style.color = '#ff4757';
        performanceElement.style.color = '#ff4757';
    }
}

function startAutomaticBacktest() {
    console.log('Starting automatic backtest system...');
    
    // Start the automatic backtest
    fetch('/api/backtest/auto-run', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Auto backtest started:', data);
        
        if (data.success) {
            document.getElementById('auto-status').textContent = 'Backtests automatiques actifs';
            
            // Start periodic updates
            autoBacktestInterval = setInterval(updateAutomaticBacktest, 3000);
            
            // Initial update
            setTimeout(updateAutomaticBacktest, 1000);
        } else {
            document.getElementById('auto-status').textContent = 'Erreur lors du démarrage';
        }
    })
    .catch(error => {
        console.error('Error starting automatic backtest:', error);
        document.getElementById('auto-status').textContent = 'Erreur de connexion au serveur';
    });
}

function updateAutomaticBacktest() {
    fetch('/api/backtest/status')
        .then(response => response.json())
        .then(data => {
            console.log('Backtest status update:', data);
            
            if (data.data_source === 'live_api') {
                document.getElementById('auto-status').textContent = 'Données de marché en temps réel actives';
                
                if (data.total_return !== undefined) {
                    const totalReturnElement = document.getElementById('auto-total-return');
                    const dailyReturnElement = document.getElementById('auto-daily-return');
                    
                    if (totalReturnElement) {
                        totalReturnElement.textContent = (data.total_return * 100).toFixed(2) + '%';
                    }
                    if (dailyReturnElement) {
                        dailyReturnElement.textContent = (data.daily_return * 100).toFixed(2) + '%';
                    }
                    
                    const newCapital = 500 + (500 * data.total_return);
                    updateCapitalChart(newCapital);
                    
                    const lastUpdateElement = document.getElementById('last-update');
                    if (lastUpdateElement) {
                        const now = new Date().toLocaleTimeString();
                        lastUpdateElement.textContent = `Dernière mise à jour: ${now}`;
                    }
                    
                    const dataSourceElement = document.getElementById('data-source');
                    if (dataSourceElement) {
                        dataSourceElement.textContent = data.data_source || 'API Live';
                    }
                    
                    const lastUpdateElement = document.getElementById('last-update');
                    if (lastUpdateElement) {
                        const now = new Date().toLocaleTimeString();
                        lastUpdateElement.textContent = `Dernière mise à jour: ${now}`;
                    }
                    
                    console.log('Backtest data updated:', data);
                }
                
                if (data.sharpe_ratio !== undefined) {
                    const sharpeElement = document.getElementById('auto-sharpe');
                    if (sharpeElement) {
                        sharpeElement.textContent = data.sharpe_ratio.toFixed(2);
                    }
                }
                
                const tradingStatusElement = document.getElementById('trading-status');
                const tradingProfitElement = document.getElementById('trading-profit');
                const totalTradesElement = document.getElementById('total-trades');
                
                if (tradingStatusElement) {
                    tradingStatusElement.textContent = `${data.active_positions || 0} positions actives`;
                }
                if (tradingProfitElement) {
                    tradingProfitElement.textContent = ((data.total_return || 0) * 1000).toFixed(2) + '€';
                }
                if (totalTradesElement) {
                    totalTradesElement.textContent = data.active_positions || 0;
                }
            } else {
                document.getElementById('auto-status').textContent = 'Configuration des clés API requise';
            }
        })
        .catch(error => {
            console.error('Error updating backtest:', error);
            document.getElementById('auto-status').textContent = 'Erreur de connexion au serveur';
        });
    
    fetch('/api/backtest/optimization-status')
        .then(response => response.json())
        .then(data => {
            console.log('Optimization status update:', data);
            
            if (data.status === 'running' && data.metrics) {
                // Update main metrics (with safety checks)
                if (data.metrics.total_return !== undefined) {
                    document.getElementById('auto-total-return').textContent = data.metrics.total_return.toFixed(2) + '%';
                    
                    // Calculate daily return (assuming monthly data)
                    const dailyReturn = data.metrics.total_return / 30;
                    document.getElementById('auto-daily-return').textContent = dailyReturn.toFixed(2) + '%';
                    
                    // Calculate new capital based on total return
                    const newCapital = 500 + (500 * data.metrics.total_return / 100);
                    updateCapitalChart(newCapital);
                }
                
                if (data.metrics.sharpe !== undefined) {
                    document.getElementById('auto-sharpe').textContent = data.metrics.sharpe.toFixed(2);
                }
                
                // Update module status
                if (data.modules) {
                    const trading = data.modules.trading;
                    const ecommerce = data.modules.ecommerce;
                    const arbitrage = data.modules.arbitrage;
                    
                    if (trading) {
                        document.getElementById('trading-status').textContent = `${trading.current_trades || 0} positions actives`;
                        document.getElementById('trading-profit').textContent = (trading.profit || 0).toFixed(2) + '€';
                    }
                    
                    if (ecommerce) {
                        document.getElementById('ecommerce-status').textContent = `${ecommerce.products_analyzed || 0} produits analysés`;
                        document.getElementById('ecommerce-profit').textContent = (ecommerce.profit || 0).toFixed(2) + '€';
                    }
                    
                    if (arbitrage) {
                        document.getElementById('arbitrage-status').textContent = `${arbitrage.opportunities_scanned || 0} opportunités scannées`;
                        document.getElementById('arbitrage-profit').textContent = (arbitrage.profit || 0).toFixed(2) + '€';
                    }
                }
                
                // Update detailed metrics
                if (data.total_trades !== undefined) {
                    document.getElementById('total-trades').textContent = data.total_trades;
                }
                
                // Update status messages
                if (data.status_messages && data.status_messages.length > 0) {
                    document.getElementById('auto-status').textContent = data.status_messages.join(' | ');
                }
                
            } else if (data.status === 'inactive') {
                document.getElementById('auto-status').textContent = 'Configuration des clés API requise';
                
                // Reset metrics to initial state
                document.getElementById('auto-total-return').textContent = '0.00%';
                document.getElementById('auto-daily-return').textContent = '0.00%';
                document.getElementById('auto-sharpe').textContent = '0.00';
                
                document.getElementById('trading-status').textContent = 'En attente...';
                document.getElementById('ecommerce-status').textContent = 'En attente...';
                document.getElementById('arbitrage-status').textContent = 'En attente...';
            }
        })
        .catch(error => {
            console.error('Error updating automatic backtest:', error);
            document.getElementById('auto-status').textContent = 'Erreur de connexion au serveur';
        });
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoBacktestInterval) {
        clearInterval(autoBacktestInterval);
    }
});
</script>
{% endblock %}
