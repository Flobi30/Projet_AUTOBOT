{% extends "base.html" %}

{% block title %}Backtest - AUTOBOT{% endblock %}

{% block header_title %}Backtest{% endblock %}

{% block content %}
<style>
/* Override any conflicting CSS to fix spacing between sidebar and content */
.main-content {
    margin-left: 250px !important;
    padding-left: 20px !important;
}
</style>
<div class="dashboard-grid">
    <!-- Status Header -->
    <div class="status-header" style="grid-column: span 12;">
        <div class="status-indicator">
            <div class="status-dot"></div>
            <h2 class="neon-text">Moteur de Backtest AUTOBOT</h2>
        </div>
        <p id="system-status">Optimisation des stratégies en cours...</p>
        <p id="last-update" style="font-size: 0.9em; color: #888;">Dernière mise à jour: --</p>
    </div>

    <!-- Performance Metrics -->
    <div class="metrics-grid" style="grid-column: span 12;">
        <div class="metric-card">
            <div class="metric-label">Rendement Total</div>
            <div class="metric-value" id="total-return">+0.00%</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Rendement Journalier</div>
            <div class="metric-value" id="daily-return">+0.00%</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Ratio de Sharpe</div>
            <div class="metric-value" id="sharpe-ratio">0.00</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Positions Actives</div>
            <div class="metric-value" id="active-positions">0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Stratégies Testées</div>
            <div class="metric-value" id="strategies-tested">0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Source de Données</div>
            <div class="metric-value" id="data-source" style="font-size: 1.2em;">API Live</div>
        </div>
    </div>

    <!-- Activity Section -->
    <div class="activity-section">
        <!-- Real-time Activity Log -->
        <div class="activity-card">
            <div class="activity-header">
                <h3 class="neon-text">Activité en Temps Réel</h3>
                <span id="log-count">0 événements</span>
            </div>
            <div class="activity-log" id="activity-log">
                <div class="log-entry">
                    <span class="log-timestamp">--:--:--</span>
                    <span class="log-success">Initialisation du moteur de backtest...</span>
                </div>
            </div>
        </div>

        <!-- Active Strategies -->
        <div class="activity-card">
            <div class="activity-header">
                <h3 class="neon-text">Stratégies Actives</h3>
                <span id="strategy-count">0 stratégies</span>
            </div>
            <div class="strategy-list" id="strategy-list">
                <div class="strategy-item">
                    <div class="strategy-name">Initialisation...</div>
                    <div class="strategy-performance">--</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Chart -->
    <div class="chart-container">
        <div style="text-align: center; color: #888;">
            <h3 class="neon-text">Évolution des Performances</h3>
            <p>Graphique en temps réel des performances de trading</p>
            <canvas id="performance-chart" width="800" height="200"></canvas>
        </div>
    </div>

    <!-- Évolution du Capital Fictif -->
    <div class="card capital-chart-card">
        <div class="card-header">
            <h3 class="neon-text">Évolution du Capital Fictif (500€ Initial)</h3>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="capitalChart" height="300"></canvas>
            </div>
            <div class="metrics-row" style="margin-top: 20px;">
                <div class="metric-item">
                    <div class="metric-label">Capital Actuel</div>
                    <div class="metric-value neon-text" id="current-capital">500.00€</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Variation</div>
                    <div class="metric-value" id="capital-change">0.00€</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Performance</div>
                    <div class="metric-value" id="capital-performance">0.00%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Module Activity Status -->
    <div class="card modules-card">
        <div class="card-header">
            <h3 class="neon-text">Activité des Modules</h3>
        </div>
        <div class="card-body">
            <div class="module-status">
                <div class="metric-item">
                    <div class="metric-label">Trading</div>
                    <div class="metric-value" id="trading-status">En attente...</div>
                    <div class="metric-value neon-text" id="trading-profit">0.00€</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">E-commerce</div>
                    <div class="metric-value" id="ecommerce-status">En attente...</div>
                    <div class="metric-value neon-text" id="ecommerce-profit">0.00€</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Arbitrage</div>
                    <div class="metric-value" id="arbitrage-status">En attente...</div>
                    <div class="metric-value neon-text" id="arbitrage-profit">0.00€</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Métriques Détaillées -->
    <div class="card metrics-card">
        <div class="card-header">
            <h3 class="neon-text">Métriques de Performance Détaillées</h3>
        </div>
        <div class="card-body">
            <div class="metrics-row">
                <div class="metric-item">
                    <div class="metric-label">Trades Total</div>
                    <div class="metric-value" id="total-trades">0</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Facteur de Profit</div>
                    <div class="metric-value" id="profit-factor">0.00</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Trade Moyen</div>
                    <div class="metric-value" id="avg-trade">0.00€</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Drawdown Max</div>
                    <div class="metric-value" id="max-drawdown">0.00%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Rendement Annualisé</div>
                    <div class="metric-value" id="annual-return">0.00%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let autoBacktestInterval;
let capitalChart;
let capitalData = [500]; // Start with initial 500€
let capitalLabels = ['Début'];

document.addEventListener('DOMContentLoaded', function() {
    console.log('Backtest page loaded');
    
    // Initialize capital chart
    initializeCapitalChart();
    
    // Initialize automatic backtest system
    startAutomaticBacktest();
});

function initializeCapitalChart() {
    const ctx = document.getElementById('capitalChart').getContext('2d');
    
    capitalChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: capitalLabels,
            datasets: [{
                label: 'Capital (€)',
                data: capitalData,
                borderColor: '#00ff9d',
                backgroundColor: 'rgba(0, 255, 157, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#ffffff'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                y: {
                    ticks: {
                        color: '#ffffff',
                        callback: function(value) {
                            return value + '€';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}

function updateCapitalChart(newCapital) {
    const now = new Date();
    const timeLabel = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');
    
    capitalData.push(newCapital);
    capitalLabels.push(timeLabel);
    
    // Keep only last 20 data points
    if (capitalData.length > 20) {
        capitalData.shift();
        capitalLabels.shift();
    }
    
    capitalChart.data.labels = capitalLabels;
    capitalChart.data.datasets[0].data = capitalData;
    capitalChart.update();
    
    // Update capital metrics
    const variation = newCapital - 500;
    const performance = ((newCapital - 500) / 500) * 100;
    
    document.getElementById('current-capital').textContent = newCapital.toFixed(2) + '€';
    document.getElementById('capital-change').textContent = (variation >= 0 ? '+' : '') + variation.toFixed(2) + '€';
    document.getElementById('capital-performance').textContent = (performance >= 0 ? '+' : '') + performance.toFixed(2) + '%';
    
    // Update color based on performance
    const changeElement = document.getElementById('capital-change');
    const performanceElement = document.getElementById('capital-performance');
    
    if (variation >= 0) {
        changeElement.style.color = '#00ff9d';
        performanceElement.style.color = '#00ff9d';
    } else {
        changeElement.style.color = '#ff4757';
        performanceElement.style.color = '#ff4757';
    }
}

function startAutomaticBacktest() {
    console.log('Starting automatic backtest system...');
    
    // Start the automatic backtest
    fetch('/api/backtest/auto-run', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Auto backtest started:', data);
        
        if (data.success) {
            document.getElementById('auto-status').textContent = 'Backtests automatiques actifs';
            
            // Start periodic updates
            autoBacktestInterval = setInterval(updateAutomaticBacktest, 3000);
            
            // Initial update
            setTimeout(updateAutomaticBacktest, 1000);
        } else {
            document.getElementById('auto-status').textContent = 'Erreur lors du démarrage';
        }
    })
    .catch(error => {
        console.error('Error starting automatic backtest:', error);
        document.getElementById('auto-status').textContent = 'Erreur de connexion au serveur';
    });
}

function updateAutomaticBacktest() {
    fetch('/api/backtest/status')
        .then(response => response.json())
        .then(data => {
            console.log('Strategy performance update:', data);
            
            if (data.status === 'running') {
                document.getElementById('system-status').textContent = 'Stratégies actives - Performance en temps réel';
                
                if (data.total_return !== undefined) {
                    // Update main metrics with simplified display
                    document.getElementById('total-return').textContent = (data.total_return * 100).toFixed(2) + '%';
                    document.getElementById('daily-return').textContent = (data.daily_return * 100).toFixed(2) + '%';
                    document.getElementById('sharpe-ratio').textContent = data.sharpe_ratio.toFixed(2);
                    document.getElementById('active-positions').textContent = data.active_positions || 0;
                    document.getElementById('strategies-tested').textContent = data.strategies_tested || 0;
                    
                    const newCapital = 500 + (500 * data.total_return);
                    updateCapitalChart(newCapital);
                    
                    const lastUpdateElement = document.getElementById('last-update');
                    if (lastUpdateElement) {
                        const now = new Date().toLocaleTimeString();
                        lastUpdateElement.textContent = `Dernière mise à jour: ${now}`;
                    }
                    
                    // Update data source with simplified display
                    document.getElementById('data-source').textContent = data.current_strategy || 'Multi-API Strategy';
                    
                    // Update timestamp
                    const now = new Date().toLocaleTimeString();
                    document.getElementById('last-update').textContent = `Dernière mise à jour: ${now}`;
                    
                    // Update activity log with simplified strategy info
                    const activityLog = document.getElementById('activity-log');
                    const now = new Date().toLocaleTimeString();
                    
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.innerHTML = `
                        <span class="log-timestamp">${now}</span>
                        <span class="log-success">Stratégie: ${data.current_strategy} - Performance: ${(data.total_return * 100).toFixed(2)}%</span>
                    `;
                    
                    activityLog.insertBefore(logEntry, activityLog.firstChild);
                    
                    // Keep only last 5 entries
                    while (activityLog.children.length > 5) {
                        activityLog.removeChild(activityLog.lastChild);
                    }
                    
                    // Update strategy list
                    const strategyList = document.getElementById('strategy-list');
                    strategyList.innerHTML = `
                        <div class="strategy-item">
                            <div class="strategy-name">${data.current_strategy}</div>
                            <div class="strategy-performance">${(data.total_return * 100).toFixed(2)}% - ${data.active_positions} positions</div>
                        </div>
                    `;
                    
                    // Update counts
                    document.getElementById('log-count').textContent = `${activityLog.children.length} événements`;
                    document.getElementById('strategy-count').textContent = `${data.strategies_tested || 1} stratégies`;
                }
            } else {
                document.getElementById('auto-status').textContent = 'Configuration des clés API requise';
            }
        })
        .catch(error => {
            console.error('Error updating backtest:', error);
            document.getElementById('auto-status').textContent = 'Erreur de connexion au serveur';
        });
    
    fetch('/api/backtest/optimization-status')
        .then(response => response.json())
        .then(data => {
            console.log('Optimization status update:', data);
            
            if (data.status === 'running' && data.metrics) {
                // Update main metrics (with safety checks)
                if (data.metrics.total_return !== undefined) {
                    document.getElementById('auto-total-return').textContent = data.metrics.total_return.toFixed(2) + '%';
                    
                    // Calculate daily return (assuming monthly data)
                    const dailyReturn = data.metrics.total_return / 30;
                    document.getElementById('auto-daily-return').textContent = dailyReturn.toFixed(2) + '%';
                    
                    // Calculate new capital based on total return
                    const newCapital = 500 + (500 * data.metrics.total_return / 100);
                    updateCapitalChart(newCapital);
                }
                
                if (data.metrics.sharpe !== undefined) {
                    document.getElementById('auto-sharpe').textContent = data.metrics.sharpe.toFixed(2);
                }
                
                // Update module status
                if (data.modules) {
                    const trading = data.modules.trading;
                    const ecommerce = data.modules.ecommerce;
                    const arbitrage = data.modules.arbitrage;
                    
                    if (trading) {
                        document.getElementById('trading-status').textContent = `${trading.current_trades || 0} positions actives`;
                        document.getElementById('trading-profit').textContent = (trading.profit || 0).toFixed(2) + '€';
                    }
                    
                    if (ecommerce) {
                        document.getElementById('ecommerce-status').textContent = `${ecommerce.products_analyzed || 0} produits analysés`;
                        document.getElementById('ecommerce-profit').textContent = (ecommerce.profit || 0).toFixed(2) + '€';
                    }
                    
                    if (arbitrage) {
                        document.getElementById('arbitrage-status').textContent = `${arbitrage.opportunities_scanned || 0} opportunités scannées`;
                        document.getElementById('arbitrage-profit').textContent = (arbitrage.profit || 0).toFixed(2) + '€';
                    }
                }
                
                // Update detailed metrics
                if (data.total_trades !== undefined) {
                    document.getElementById('total-trades').textContent = data.total_trades;
                }
                
                // Update status messages
                if (data.status_messages && data.status_messages.length > 0) {
                    document.getElementById('auto-status').textContent = data.status_messages.join(' | ');
                }
                
            } else if (data.status === 'inactive') {
                document.getElementById('auto-status').textContent = 'Configuration des clés API requise';
                
                // Reset metrics to initial state
                document.getElementById('auto-total-return').textContent = '0.00%';
                document.getElementById('auto-daily-return').textContent = '0.00%';
                document.getElementById('auto-sharpe').textContent = '0.00';
                
                document.getElementById('trading-status').textContent = 'En attente...';
                document.getElementById('ecommerce-status').textContent = 'En attente...';
                document.getElementById('arbitrage-status').textContent = 'En attente...';
            }
        })
        .catch(error => {
            console.error('Error updating automatic backtest:', error);
            document.getElementById('auto-status').textContent = 'Erreur de connexion au serveur';
        });
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoBacktestInterval) {
        clearInterval(autoBacktestInterval);
    }
});
</script>
{% endblock %}
