{% extends "base.html" %}

{% block title %}Paramètres{% endblock %}

{% block header_title %}Paramètres du Système{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" id="save-settings-btn">
    <i class="fas fa-save"></i> Enregistrer
</button>
{% endblock %}

{% block content %}
<div class="settings-layout" style="width: 100%; max-width: none;">


    <!-- Contenu des paramètres -->
    <div class="settings-content" style="width: 100%;">
        <!-- Configuration API Automatisée -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-key"></i> Configuration API - Mode Automatique</h3>
                <div class="auto-mode-indicator">
                    <i class="fas fa-robot"></i> Optimisation Automatique Activée
                </div>
            </div>
            <div class="card-body">
                <div class="auto-config-notice">
                    <div class="notice-content">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Mode Automatique:</strong> Saisissez uniquement vos clés API. 
                            Tous les paramètres sont optimisés automatiquement pour un rendement de 10% quotidien.
                        </div>
                    </div>
                </div>
                <form id="api-settings-form">
                        <div class="form-group">
                            <label for="binance-api-key">Binance API Key</label>
                            <div class="input-group">
                                <input type="password" id="binance-api-key" class="form-control" value="{{ binance_api_key|default('') }}" placeholder="Entrez votre clé API Binance">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="binance-api-key">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="binance-api-secret">Binance API Secret</label>
                            <div class="input-group">
                                <input type="password" id="binance-api-secret" class="form-control" value="{{ binance_api_secret|default('') }}" placeholder="Entrez votre secret API Binance">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="binance-api-secret">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="openai-api-key">OpenAI API Key</label>
                            <div class="input-group">
                                <input type="password" id="openai-api-key" class="form-control" value="{{ openai_api_key|default('') }}" placeholder="Entrez votre clé API OpenAI">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="openai-api-key">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="superagi-api-key">SuperAGI API Key</label>
                            <div class="input-group">
                                <input type="password" id="superagi-api-key" class="form-control" value="{{ superagi_api_key|default('') }}" placeholder="Entrez votre clé API SuperAGI">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="superagi-api-key">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="stripe-api-key">Stripe API Key</label>
                            <div class="input-group">
                                <input type="password" id="stripe-api-key" class="form-control" value="{{ stripe_api_key|default('') }}" placeholder="Entrez votre clé API Stripe">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="stripe-api-key">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newsapi-api-key">NewsAPI Key</label>
                            <div class="input-group">
                                <input type="password" id="newsapi-api-key" class="form-control" value="{{ newsapi_api_key|default('') }}" placeholder="Entrez votre clé API NewsAPI">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="newsapi-api-key">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        

                        
                        <div class="form-group">
                            <label for="twelve-data-api-key">Twelve Data API Key</label>
                            <div class="input-group">
                                <input type="password" id="twelve-data-api-key" class="form-control" value="{{ twelve_data_api_key|default('') }}" placeholder="Entrez votre clé API Twelve Data">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="twelve-data-api-key">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="fred-api-key">FRED API Key</label>
                            <div class="input-group">
                                <input type="password" id="fred-api-key" class="form-control" value="{{ fred_api_key|default('') }}" placeholder="Entrez votre clé API FRED">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="fred-api-key">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="shopify-api-key">Shopify API Key</label>
                            <div class="input-group">
                                <input type="password" id="shopify-api-key" class="form-control" value="{{ shopify_api_key|default('') }}" placeholder="Entrez votre clé API Shopify">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="shopify-api-key">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="shopify-api-secret">Shopify API Secret</label>
                            <div class="input-group">
                                <input type="password" id="shopify-api-secret" class="form-control" value="{{ shopify_api_secret|default('') }}" placeholder="Entrez votre secret API Shopify">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="shopify-api-secret">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="coinbase-api-key">Coinbase API Key</label>
                            <div class="input-group">
                                <input type="password" id="coinbase-api-key" class="form-control" value="{{ coinbase_api_key|default('') }}" placeholder="Entrez votre clé API Coinbase">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="coinbase-api-key">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="coinbase-api-secret">Coinbase API Secret</label>
                            <div class="input-group">
                                <input type="password" id="coinbase-api-secret" class="form-control" value="{{ coinbase_api_secret|default('') }}" placeholder="Entrez votre secret API Coinbase">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="coinbase-api-secret">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="kraken-api-key">Kraken API Key</label>
                            <div class="input-group">
                                <input type="password" id="kraken-api-key" class="form-control" value="{{ kraken_api_key|default('') }}" placeholder="Entrez votre clé API Kraken">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="kraken-api-key">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="shopify-shop-name">Shopify Shop Name</label>
                            <div class="input-group">
                                <input type="text" id="shopify-shop-name" class="form-control" value="{{ shopify_shop_name|default('') }}" placeholder="Entrez le nom de votre boutique Shopify (ex: monshop)">
                                <div class="input-group-append">
                                    <button class="btn btn-outline toggle-password" type="button" data-target="shopify-shop-name">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="test-api-keys">Tester les Clés API</label>
                            <button type="button" id="test-api-keys" class="btn btn-outline">
                                <i class="fas fa-vial"></i> Tester la Connectivité
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <style>
            .auto-mode-indicator {
                color: #00ff9d;
                font-weight: bold;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
            }
            
            .auto-config-notice {
                background: rgba(0, 255, 157, 0.1);
                border: 1px solid #00ff9d;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 25px;
            }
            
            .notice-content {
                display: flex;
                align-items: flex-start;
                gap: 12px;
                color: #ffffff;
            }
            
            .notice-content i {
                color: #00ff9d;
                font-size: 18px;
                margin-top: 2px;
            }
            
            .notice-content strong {
                color: #00ff9d;
            }
        </style>




    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Modal Changement de Mot de Passe -->
<div class="modal" id="changePasswordModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title neon-text">Changer le Mot de Passe</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="change-password-form">
                    <div class="form-group">
                        <label for="current-password">Mot de Passe Actuel</label>
                        <input type="password" id="current-password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">Nouveau Mot de Passe</label>
                        <input type="password" id="new-password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirmer le Mot de Passe</label>
                        <input type="password" id="confirm-password" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="changePassword()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Configuration 2FA -->
<div class="modal" id="setup2FAModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title neon-text">Configuration 2FA</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <p>Scannez ce QR code avec votre application d'authentification (Google Authenticator, Authy, etc.)</p>
                    <div class="qr-code-container">
                        <img src="/static/img/qr-placeholder.png" alt="QR Code 2FA" class="qr-code">
                    </div>
                </div>
                <form id="setup-2fa-form">
                    <div class="form-group">
                        <label for="verification-code">Code de Vérification</label>
                        <input type="text" id="verification-code" class="form-control" placeholder="Entrez le code à 6 chiffres" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="verify2FACode()">Vérifier</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Navigation des paramètres
        const menuItems = document.querySelectorAll('.settings-menu-item');
        const sections = document.querySelectorAll('.settings-section');
        
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                const target = this.getAttribute('data-target');
                
                // Désactiver tous les éléments du menu et sections
                menuItems.forEach(mi => mi.classList.remove('active'));
                sections.forEach(section => section.classList.remove('active'));
                
                // Activer l'élément du menu et la section correspondante
                this.classList.add('active');
                document.getElementById(target).classList.add('active');
            });
        });
        
        // Toggle affichage mot de passe
        const toggleButtons = document.querySelectorAll('.toggle-password');
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                
                if (input.type === 'password') {
                    input.type = 'text';
                    this.innerHTML = '<i class="fas fa-eye-slash"></i>';
                } else {
                    input.type = 'password';
                    this.innerHTML = '<i class="fas fa-eye"></i>';
                }
            });
        });
        
        // Affichage de la valeur du range
        const temperatureRange = document.getElementById('superagi-temperature');
        const rangeValue = document.querySelector('.range-value');
        
        if (temperatureRange && rangeValue) {
            temperatureRange.addEventListener('input', function() {
                rangeValue.textContent = this.value;
            });
        }
        
        // Bouton de sauvegarde
        const saveButton = document.getElementById('save-settings-btn');
        if (saveButton) {
            saveButton.addEventListener('click', function() {
                saveSettings();
            });
        }
    });
    
    async function saveSettings() {
        try {
            // Afficher un indicateur de chargement
            const saveButton = document.getElementById('save-settings-btn');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
            saveButton.disabled = true;
            
            // Collecter uniquement les données API pour l'automatisation
            const apiSettings = {
                'binance-api-key': document.getElementById('binance-api-key')?.value || '',
                'binance-api-secret': document.getElementById('binance-api-secret')?.value || '',
                'openai-api-key': document.getElementById('openai-api-key')?.value || '',
                'superagi-api-key': document.getElementById('superagi-api-key')?.value || '',
                'stripe-api-key': document.getElementById('stripe-api-key')?.value || '',
                'twelve-data-api-key': document.getElementById('twelve-data-api-key')?.value || '',
                'fred-api-key': document.getElementById('fred-api-key')?.value || '',
                'newsapi-api-key': document.getElementById('newsapi-api-key')?.value || '',
                'shopify-api-key': document.getElementById('shopify-api-key')?.value || '',
                'shopify-api-secret': document.getElementById('shopify-api-secret')?.value || '',
                'coinbase-api-key': document.getElementById('coinbase-api-key')?.value || '',
                'coinbase-api-secret': document.getElementById('coinbase-api-secret')?.value || '',
                'kraken-api-key': document.getElementById('kraken-api-key')?.value || '',
                'kraken-api-secret': document.getElementById('kraken-api-secret')?.value || '',
                'shopify-shop-name': document.getElementById('shopify-shop-name')?.value || ''
            };
            
            const allSettings = {
                api: apiSettings
            };
            
            // Envoyer les données au serveur
            const response = await fetch('/api/save-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(allSettings)
            });
            
            // Restaurer le bouton
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
            
            if (response.ok) {
                const data = await response.json();
                showNotification(data.message || 'Paramètres enregistrés avec succès', 'success');
            } else {
                const errorData = await response.json().catch(() => ({ message: 'Erreur lors de la sauvegarde des paramètres' }));
                showNotification(errorData.message || 'Erreur lors de la sauvegarde des paramètres', 'error');
            }
        } catch (error) {
            console.error('Erreur lors de la sauvegarde des paramètres:', error);
            showNotification('Erreur lors de la sauvegarde des paramètres', 'error');
            
            // Restaurer le bouton en cas d'erreur
            const saveButton = document.getElementById('save-settings-btn');
            saveButton.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
            saveButton.disabled = false;
        }
    }
    
    function collectFormData(formId) {
        const form = document.getElementById(formId);
        if (!form) return {};
        
        const formData = {};
        const elements = form.elements;
        
        for (let i = 0; i < elements.length; i++) {
            const element = elements[i];
            if (element.name || element.id) {
                const key = element.name || element.id;
                
                if (element.type === 'checkbox') {
                    formData[key] = element.checked;
                } else if (element.type === 'radio') {
                    if (element.checked) {
                        formData[key] = element.value;
                    }
                } else {
                    formData[key] = element.value;
                }
            }
        }
        
        return formData;
    }
    
    function showNotification(message, type = 'info') {
        // Créer une notification
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-icon">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            </div>
            <div class="notification-content">
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Ajouter au conteneur de notifications
        const container = document.querySelector('.notification-container') || createNotificationContainer();
        container.appendChild(notification);
        
        // Ajouter l'événement de fermeture
        const closeButton = notification.querySelector('.notification-close');
        closeButton.addEventListener('click', () => {
            notification.classList.add('notification-hiding');
            setTimeout(() => {
                notification.remove();
                if (container.children.length === 0) {
                    container.remove();
                }
            }, 300);
        });
        
        // Auto-fermeture après 5 secondes
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.add('notification-hiding');
                setTimeout(() => {
                    notification.remove();
                    if (container.children.length === 0) {
                        container.remove();
                    }
                }, 300);
            }
        }, 5000);
    }
    
    function createNotificationContainer() {
        const container = document.createElement('div');
        container.className = 'notification-container';
        document.body.appendChild(container);
        return container;
    }
    
    function changePassword() {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            showNotification('Veuillez remplir tous les champs', 'error');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showNotification('Les mots de passe ne correspondent pas', 'error');
            return;
        }
        
        // Simuler une requête API
        console.log('Changing password...');
        setTimeout(() => {
            showNotification('Mot de passe modifié avec succès', 'success');
            $('#changePasswordModal').modal('hide');
            
            // Réinitialiser le formulaire
            document.getElementById('change-password-form').reset();
        }, 1000);
    }
    
    function verify2FACode() {
        const code = document.getElementById('verification-code').value;
        
        if (!code || code.length !== 6) {
            showNotification('Veuillez entrer un code à 6 chiffres', 'error');
            return;
        }
        
        // Simuler une requête API
        console.log('Verifying 2FA code:', code);
        setTimeout(() => {
            showNotification('2FA activé avec succès', 'success');
            $('#setup2FAModal').modal('hide');
            
            // Réinitialiser le formulaire
            document.getElementById('setup-2fa-form').reset();
        }, 1000);
    }
</script>
{% endblock %}
