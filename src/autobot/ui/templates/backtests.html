{% extends "base.html" %}

{% block title %}Backtests AUTOBOT{% endblock %}

{% block content %}
<div class="container">
    <h1 class="main-title">Backtests Automatiques</h1>
    
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h2>Configuration des seuils</h2>
                </div>
                <div class="card-body">
                    <form id="thresholds-form">
                        <div class="form-group">
                            <label for="min_sharpe">Sharpe Ratio Minimum</label>
                            <input type="number" step="0.1" id="min_sharpe" name="min_sharpe" value="1.5" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="max_drawdown">Drawdown Maximum (%)</label>
                            <input type="number" step="0.1" id="max_drawdown" name="max_drawdown" value="15" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="min_pnl">P&L Minimum (%)</label>
                            <input type="number" step="0.1" id="min_pnl" name="min_pnl" value="10" class="form-control">
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="auto_live" name="auto_live">
                            <label class="form-check-label" for="auto_live">Auto-Live (Passage automatique en production)</label>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3" id="update-thresholds">Mettre Ã  jour les seuils</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2>Backtests en cours</h2>
                    <div class="overall-status">
                        <span class="badge badge-info" id="overall-status">ðŸ”„ Backtesting</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="backtests-table">
                            <thead>
                                <tr>
                                    <th>StratÃ©gie</th>
                                    <th>Symbole</th>
                                    <th>ProgrÃ¨s</th>
                                    <th>P&L</th>
                                    <th>Sharpe</th>
                                    <th>Drawdown</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- DonnÃ©es dynamiques des backtests -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h2>Graphique de performance</h2>
                </div>
                <div class="card-body">
                    <canvas id="performance-chart" height="250"></canvas>
                </div>
            </div>
            
            <div class="card mt-4" id="live-card" style="display: none;">
                <div class="card-header">
                    <h2>PrÃªt pour passage en production</h2>
                </div>
                <div class="card-body text-center">
                    <p class="alert alert-success">Tous les backtests ont atteint les seuils requis!</p>
                    <button id="go-live-button" class="btn btn-danger btn-lg pulse">Passer en Production</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let chart;
    let backtestsData = [];
    let liveReady = false;
    
    // Configuration des seuils
    const thresholdsForm = document.getElementById('thresholds-form');
    thresholdsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(thresholdsForm);
        const jsonData = {};
        
        formData.forEach((value, key) => {
            jsonData[key] = key === 'auto_live' ? true : parseFloat(value);
        });
        
        // Si pas de case cochÃ©e, auto_live sera absent du formData
        if (!formData.has('auto_live')) {
            jsonData.auto_live = false;
        }
        
        fetch('/api/backtest/thresholds', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jsonData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Seuils mis Ã  jour avec succÃ¨s');
            } else {
                alert('Erreur: ' + (data.message || 'Mise Ã  jour impossible'));
            }
        });
    });
    
    // Passage en production
    const goLiveButton = document.getElementById('go-live-button');
    goLiveButton.addEventListener('click', function() {
        fetch('/api/trading/live', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('overall-status').textContent = 'ðŸš€ Live';
                document.getElementById('overall-status').className = 'badge badge-success';
                setTimeout(() => {
                    window.location.href = '/operations';
                }, 2000);
            } else {
                alert('Erreur lors du passage en production: ' + (data.message || 'Erreur inconnue'));
            }
        });
    });
    
    // Mise Ã  jour pÃ©riodique des donnÃ©es
    function fetchBacktestStatus() {
        fetch('/api/backtest/status')
        .then(response => response.json())
        .then(data => {
            backtestsData = data.backtests;
            updateBacktestsTable();
            updatePerformanceChart();
            checkLiveReadiness();
        })
        .catch(error => console.error('Erreur:', error));
    }
    
    function updateBacktestsTable() {
        const tbody = document.querySelector('#backtests-table tbody');
        tbody.innerHTML = '';
        
        backtestsData.forEach(backtest => {
            const tr = document.createElement('tr');
            
            // Status class
            const statusClass = backtest.status === 'completed' 
                ? 'success' : backtest.status === 'failed' 
                ? 'danger' : 'info';
            
            // Progress display
            const progressBar = `
                <div class="progress">
                    <div class="progress-bar bg-${statusClass}" role="progressbar" 
                         style="width: ${backtest.progress}%" 
                         aria-valuenow="${backtest.progress}" aria-valuemin="0" aria-valuemax="100">
                        ${backtest.progress}%
                    </div>
                </div>
            `;
            
            tr.innerHTML = `
                <td>${backtest.strategy}</td>
                <td>${backtest.symbol}</td>
                <td>${progressBar}</td>
                <td>${backtest.metrics.pnl ? backtest.metrics.pnl.toFixed(2) + '%' : 'N/A'}</td>
                <td>${backtest.metrics.sharpe ? backtest.metrics.sharpe.toFixed(2) : 'N/A'}</td>
                <td>${backtest.metrics.drawdown ? backtest.metrics.drawdown.toFixed(2) + '%' : 'N/A'}</td>
                <td><span class="badge badge-${statusClass}">${backtest.status}</span></td>
            `;
            
            tbody.appendChild(tr);
        });
    }
    
    function updatePerformanceChart() {
        const ctx = document.getElementById('performance-chart').getContext('2d');
        
        if (chart) {
            chart.destroy();
        }
        
        // PrÃ©paration des donnÃ©es pour le graphique
        const datasets = backtestsData.map((backtest, index) => {
            // GÃ©nÃ©ration de couleurs distinctes
            const hue = (index * 137) % 360;
            const color = `hsl(${hue}, 70%, 60%)`;
            
            return {
                label: `${backtest.strategy} - ${backtest.symbol}`,
                data: backtest.equity_curve ? backtest.equity_curve.values : [],
                borderColor: color,
                backgroundColor: color + '20', // version transparente
                fill: false,
                tension: 0.1
            };
        });
        
        const labels = backtestsData.length > 0 && backtestsData[0].equity_curve 
            ? backtestsData[0].equity_curve.dates 
            : [];
        
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Valeur'
                        }
                    }
                }
            }
        });
    }
    
    function checkLiveReadiness() {
        const thresholds = {
            min_sharpe: parseFloat(document.getElementById('min_sharpe').value),
            max_drawdown: parseFloat(document.getElementById('max_drawdown').value),
            min_pnl: parseFloat(document.getElementById('min_pnl').value)
        };
        
        // VÃ©rifier si tous les backtests ont atteint les seuils
        const allComplete = backtestsData.every(b => b.status === 'completed');
        const allMeetThresholds = backtestsData.every(b => 
            b.metrics.sharpe >= thresholds.min_sharpe &&
            b.metrics.drawdown <= thresholds.max_drawdown &&
            b.metrics.pnl >= thresholds.min_pnl
        );
        
        liveReady = allComplete && allMeetThresholds && backtestsData.length > 0;
        
        document.getElementById('live-card').style.display = liveReady ? 'block' : 'none';
        
        // Si auto-live est activÃ© et tous les seuils sont atteints, passer en production automatiquement
        if (liveReady && document.getElementById('auto_live').checked) {
            goLiveButton.click();
        }
    }
    
    // Initialiser les donnÃ©es et mettre Ã  jour pÃ©riodiquement
    fetchBacktestStatus();
    setInterval(fetchBacktestStatus, 5000);
});
</script>

<style>
.pulse {
    animation: pulse-animation 2s infinite;
}

@keyframes pulse-animation {
    0% {
        box-shadow: 0 0 0 0px rgba(220, 53, 69, 0.7);
    }
    100% {
        box-shadow: 0 0 0 20px rgba(220, 53, 69, 0);
    }
}
</style>
{% endblock %}
