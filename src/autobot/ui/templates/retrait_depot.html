{% extends "base.html" %}

{% block title %}Retrait et Dépôt{% endblock %}

{% block content %}
<script src="https://js.stripe.com/v3/"></script>
<div class="container">
    <h1 class="page-title">Retrait et Dépôt</h1>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2>Solde actuel</h2>
                </div>
                <div class="card-body">
                    <h3 class="balance-amount" id="current-balance">1000.00 €</h3>
                    <div class="button-group">
                        <button class="btn btn-primary" data-action="deposit">Ajouter des fonds</button>
                        <button class="btn btn-secondary" data-action="withdraw">Retirer des fonds</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2>Historique des transactions</h2>
                </div>
                <div class="card-body">
                    <div class="transaction-history">
                        <h3>Historique des transactions</h3>
                        <div id="transaction-loading">Chargement des transactions...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Stripe (you'll need to add your publishable key)
const stripe = Stripe('pk_live_51RWghBGH8AOThq2l7NrQW0g7V8qcF6Qsg1eRJotdD8orUfZrgy3gLI9IP10G7t1qOzXthmeR6TnyiWsBvEBVVEL900FGck3gMV');

document.querySelector('[data-action="deposit"]').addEventListener('click', async function() {
    const amount = prompt('Montant à déposer (€):');
    if (!amount || isNaN(amount) || amount <= 0) {
        alert('Veuillez entrer un montant valide');
        return;
    }
    
    try {
        const response = await fetch('/api/payments/deposit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({amount: parseFloat(amount)})
        });
        
        const result = await response.json();
        if (result.success) {
            // Handle Stripe payment flow
            const {error} = await stripe.confirmCardPayment(result.client_secret);
            if (!error) {
                alert('Dépôt réussi!');
                location.reload();
            } else {
                alert('Erreur lors du paiement: ' + error.message);
            }
        } else {
            alert('Erreur lors du dépôt');
        }
    } catch (error) {
        alert('Erreur lors du dépôt: ' + error.message);
    }
});

document.querySelector('[data-action="withdraw"]').addEventListener('click', async function() {
    const amount = prompt('Montant à retirer (€):');
    if (!amount || isNaN(amount) || amount <= 0) {
        alert('Veuillez entrer un montant valide');
        return;
    }
    
    try {
        const response = await fetch('/api/payments/withdraw', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                amount: parseFloat(amount),
                account_details: {account_id: 'acct_default'}
            })
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Retrait initié avec succès!');
            location.reload();
        } else {
            alert('Erreur lors du retrait');
        }
    } catch (error) {
        alert('Erreur lors du retrait: ' + error.message);
    }
});

async function loadStripeData() {
    try {
        const response = await fetch('/api/stripe/summary');
        const data = await response.json();
        
        document.getElementById('current-balance').textContent = `${data.available_balance.toFixed(2)} €`;
        
        const historyContainer = document.querySelector('.transaction-history');
        const loadingElement = document.getElementById('transaction-loading');
        
        if (loadingElement) {
            loadingElement.remove();
        }
        
        if (data.recent_transactions && data.recent_transactions.length > 0) {
            data.recent_transactions.forEach(tx => {
                const txElement = document.createElement('div');
                txElement.className = 'transaction-item';
                txElement.innerHTML = `
                    <span class="date">${new Date(tx.created).toLocaleDateString()}</span>
                    <span class="description">${tx.description}</span>
                    <span class="amount ${tx.amount > 0 ? 'positive' : 'negative'}">
                        ${tx.amount > 0 ? '+' : ''}${tx.amount.toFixed(2)} €
                    </span>
                `;
                historyContainer.appendChild(txElement);
            });
        } else {
            const noTxElement = document.createElement('div');
            noTxElement.className = 'transaction-item';
            noTxElement.innerHTML = '<span class="description">Aucune transaction trouvée</span>';
            historyContainer.appendChild(noTxElement);
        }
    } catch (error) {
        console.error('Error loading Stripe data:', error);
        const historyContainer = document.querySelector('.transaction-history');
        const loadingElement = document.getElementById('transaction-loading');
        
        if (loadingElement) {
            loadingElement.textContent = 'Erreur lors du chargement des transactions';
        }
    }
}

document.addEventListener('DOMContentLoaded', loadStripeData);
</script>
{% endblock %}

{% block scripts %}
<script>
function processDeposit() {
    const amount = document.getElementById('deposit-amount').value;
    if (!amount || amount <= 0) {
        alert('Veuillez saisir un montant valide');
        return;
    }
    
    fetch('/api/deposit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({amount: parseFloat(amount)})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Dépôt initié avec succès: ' + data.message);
            document.getElementById('deposit-amount').value = '';
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors du traitement du dépôt');
    });
}

function processWithdrawal() {
    const amount = document.getElementById('withdrawal-amount').value;
    if (!amount || amount <= 0) {
        alert('Veuillez saisir un montant valide');
        return;
    }
    
    fetch('/api/withdraw', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({amount: parseFloat(amount)})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Retrait traité avec succès: ' + data.message);
            document.getElementById('withdrawal-amount').value = '';
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors du traitement du retrait');
    });
}
</script>
{% endblock %}
